services: couchdb

language: 
- php
- node_js
- java
- python


php:
  - '5.4'

node_js: stable

cache:
  directories:
  - $HOME/.cache/pip/

sudo: required

before_install:
#- sudo apt-get -qq update
# Package for Steatite
- sudo apt-get install libimage-exiftool-perl
- sudo apt-get install sqlite3
- sudo apt-get install apache2 libapache2-mod-fastcgi

install : 

# Install Couchapp
- pip install --user couchapp  

# Install ARGOS
#- git clone https://github.com/Ozymandiiaz/Argos.git
#- cd Argos
- curl -X PUT http://127.0.0.1:5984/argos
#- couchapp init
#- couchapp push http://127.0.0.1:5984/argos
#- wget https://raw.githubusercontent.com/Ozymandiiaz/Porphyry/test-travis/Couchdb/pointview.json
#- curl -X POST http://127.0.0.1:5984/argos -d pointview.json -H “Content-Type:application/json”
#- curl -X POST http://127.0.0.1:5984/argos -d @pointview.json -H “Content-Type:application/json”
#- curl -X POST http://127.0.0.1:5984/argos -d @$TRAVIS_BUILD_DIR/Couchdb/item.json -H “Content-Type:application/json”
#- couchapp pushdocs $TRAVIS_BUILD_DIR/Couchdb/docs/ http://127.0.0.1:5984/argos
#- couchapp pushdocs $TRAVIS_BUILD_DIR/Couchdb/item.json http://127.0.0.1:5984/argos
#- couchapp pushdocs $TRAVIS_BUILD_DIR/Couchdb/text.json http://127.0.0.1:5984/argos


#- curl http://127.0.0.1:5984/argos
#- cd ..
#- curl http://127.0.0.1:5984/test/_design/argos/_rewrite/

# Install Cassandre
- curl -X PUT -d '"false"' localhost:5984/_config/httpd/secure_rewrites
- curl -X PUT localhost:5984/cassandre
- wget https://github.com/Ozymandiiaz/Cassandre/archive/travis-test.zip
- unzip travis-test.zip
- couchapp push  Cassandre-travis-test http://localhost:5984/cassandre
- cd  Cassandre-travis-test/node
- nvm install 0.12
- npm install npm@latest -g
- node --version
- npm --version
- npm install express
- npm install express-http-proxy
- npm install async
- npm install -g couchdb-dump
- node app.js &
- cd ../..

# Create DocumentRoot for Apache
- mkdir $TRAVIS_BUILD_DIR/core

# Install Steatite
- cd $TRAVIS_BUILD_DIR/core
- wget https://github.com/Ozymandiiaz/Steatite/archive/travis.zip
- unzip travis.zip
- mv  Steatite-travis/ Steatite
- cd Steatite
- mkdir -m 755 picture thumbnail attribute
- sqlite3 attribute/database <schema.sql
- sudo chown -R www-data picture thumbnail attribute
- cd $TRAVIS_BUILD_DIR

# enable php-fpm
- phpenv --version
- sudo cp ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf.default ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
- sudo a2enmod rewrite actions fastcgi alias
- echo "cgi.fix_pathinfo = 1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
- ~/.phpenv/versions/$(phpenv version-name)/sbin/php-fpm

# configure apache virtual hosts
- ls
- sudo cp -f travis-build/travis-ci-apache /etc/apache2/sites-available/default
- sudo sed -e "s?%TRAVIS_BUILD_DIR%?$(pwd)?g" --in-place /etc/apache2/sites-available/default
- sudo cat /etc/apache2/sites-available/default
- sudo service apache2 restart

#test php
#- ls
- cp php/phpinfo.php core
#- curl 127.0.0.1
#- curl 127.0.0.1/phpinfo.php
#- curl http://127.0.0.1/Steatite/

# Import Couchdb database
- curl -X PUT localhost:5984/test
- wget https://raw.githubusercontent.com/Ozymandiiaz/couchdb-dump/master/couchdb-backup.sh
#- bash couchdb-backup.sh -r -H 127.0.0.1 -d test -f $TRAVIS_BUILD_DIR/Couchdb/testdb.json
- bash couchdb-backup.sh -r -H 127.0.0.1 -d argos -f $TRAVIS_BUILD_DIR/Couchdb/argos.json
#- bash couchdb-backup.sh -r -H 127.0.0.1 -d argos -f $TRAVIS_BUILD_DIR/Couchdb/argos2.json
- curl http://127.0.0.1:5984/argos/_design/argos/_rewrite/viewpoint/446d798e240d4dee5a552b902ae56c8d


#- cdbload -d test < $TRAVIS_BUILD_DIR/Couchdb/test.json


script: 
- ant test-argos
- ant test

after_script:
  - sudo cat /var/log/apache2/error.log
  
