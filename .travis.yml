services: couchdb

language: 
- java
- node_js
- php
- python

php:
  - '5.4'

node_js: stable

cache:
  apt: true
  directories:
  - $HOME/.cache/pip/
  - $HOME/.npm
  - node_modules
  - ~/.local
  
addons:
    apt:
        packages:
            - libimage-exiftool-perl
            - sqlite3
            - apache2
            - libapache2-mod-fastcgi

sudo: required

before_install :
- pip install --user codecov


install : 

# Install Couchapp
- pip install --user couchapp  

# Install ARGOS
- curl -X PUT http://127.0.0.1:5984/argos

# Install Cassandre
- curl -X PUT -d '"false"' localhost:5984/_config/httpd/secure_rewrites
- curl -X PUT localhost:5984/cassandre
- wget https://github.com/Ozymandiiaz/Cassandre/archive/travis-test.zip
- unzip travis-test.zip
- couchapp push  Cassandre-travis-test http://localhost:5984/cassandre
- cd  Cassandre-travis-test/node
- nvm install 0.12
- npm install npm@latest -g
- npm install express
- npm install express-http-proxy
- npm install async
- node app.js &
- cd ../..

# Create DocumentRoot for Apache
- mkdir $TRAVIS_BUILD_DIR/core

# Install Steatite
- cd $TRAVIS_BUILD_DIR/core
- wget https://github.com/Ozymandiiaz/Steatite/archive/travis.zip
- unzip travis.zip
- mv  Steatite-travis/ Steatite
- cd Steatite
- mkdir -m 755 picture thumbnail attribute
- sqlite3 attribute/database <schema.sql
- sudo chown -R www-data picture thumbnail attribute
- cd $TRAVIS_BUILD_DIR



# Import Couchdb database
- curl -X PUT localhost:5984/test
- wget https://raw.githubusercontent.com/Ozymandiiaz/couchdb-dump/master/couchdb-backup.sh
- bash couchdb-backup.sh -r -H 127.0.0.1 -d argos -f $TRAVIS_BUILD_DIR/Couchdb/argos.json

script: 
- ant test-argos
- ant test
  # run my python tests
  #- coverage run ant test
  # upload my python reports
  #- bash <(curl -s https://codecov.io/bash) -cF java

after_success:
 - bash <(curl -s https://codecov.io/bash)
